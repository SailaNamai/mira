<div id="settings-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="settings-tabs">
            <button class="settings-tab active" data-list="main">Main</button>
            <button class="settings-tab" data-list="user">User</button>
        </div>

        <div class="settings-body" data-list="main">
            <input type="hidden" id="stt-mode" value="cpu">
            <input type="hidden" id="llm-mode" value="cpu">
            <input type="hidden" id="llm-vl-mode" value="cpu">
            <input type="hidden" id="tts-mode" value="cpu">

            <h3>Speech to Text</h3>
            <div class="input-row dual-control">
                <select id="setting-stt">
                    <option value="vosk">VOSK (CPU)</option>
                    <option value="canary">Placeholder 1</option>
                    <option value="faster_whisper">Placeholder 2</option>
                </select>
                <div id="stt-toggle-wrapper" class="toggle" data-target="stt-mode">
                    <button class="toggle-btn active" data-value="cpu">CPU</button>
                    <button class="toggle-btn" data-value="gpu">GPU</button>
                </div>
            </div>

            <h3>LLM</h3>
            <div class="input-row dual-control">
                <select id="setting-llm">
                    <option value="qwen3">Qwen3</option>
                    <option value="placeholder1">Placeholder 1</option>
                    <option value="placeholder2">Placeholder 2</option>
                </select>
                <div class="toggle" data-target="llm-mode">
                    <button class="toggle-btn active" data-value="cpu">CPU</button>
                    <button class="toggle-btn" data-value="gpu">GPU</button>
                </div>
            </div>

            <h3>LLM Vision</h3>
            <div class="input-row dual-control">
                <select id="setting-llm-vl">
                    <option value="qwen3_vl">Qwen3 VL</option>
                    <option value="placeholder1">Placeholder 1</option>
                    <option value="placeholder2">Placeholder 2</option>
                </select>
                <div class="toggle" data-target="llm-vl-mode">
                    <button class="toggle-btn active" data-value="cpu">CPU</button>
                    <button class="toggle-btn" data-value="gpu">GPU</button>
                </div>
            </div>

            <h3>Text to Speech</h3>
            <div class="input-row dual-control">
                <select id="setting-tts">
                    <option value="xtts_v2">XTTS-v2</option>
                    <option value="placeholder1">Placeholder 1</option>
                    <option value="placeholder2">Placeholder 2</option>
                </select>
                <div class="toggle" data-target="tts-mode">
                    <button class="toggle-btn active" data-value="cpu">CPU</button>
                    <button class="toggle-btn" data-value="gpu">GPU</button>
                </div>
            </div>

            <h3>Tasmota Smart Plug 1</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug1-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug1-ip" placeholder="IP">
            </div>
            <h3>Tasmota Smart Plug 2</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug2-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug2-ip" placeholder="IP">
            </div>
            <h3>Tasmota Smart Plug 3</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug3-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug3-ip" placeholder="IP">
            </div>
            <h3>Tasmota Smart Plug 4</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug4-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug4-ip" placeholder="IP">
            </div>
        </div>

        <div class="settings-body" data-list="user" style="display: none;">

            <h3>Name:</h3>
            <div class="input-row">
                <input type="text" id="user-setting-name" placeholder="Name">
                <input type="text" id="user-setting-age" placeholder="Birthday">
            </div>

            <h3>Location:</h3>
            <div class="input-row">
                <input type="text" id="user-setting-city" placeholder="City">
                <input type="text" id="user-setting-latitude" placeholder="Latitude">
                <input type="text" id="user-setting-longitude" placeholder="Longitude">
            </div>

            <h3>Schedule:</h3>
            <div id="schedule-container">
                <!-- Weekday blocks will be injected here -->
            </div>

            <h3>Additional info:</h3>
            <input type="text" id="user-setting-additional-info" placeholder="Additional info">
        </div>

        <div class="settings-footer">
            <button id="settings-save">Save</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('settings-modal');
    const icon = document.querySelector('.icon-settings');
    const tabs = modal.querySelectorAll('.settings-tab');
    const bodies = modal.querySelectorAll('.settings-body');
    const scheduleContainer = document.getElementById('schedule-container');
    const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // -------------------------------------------------------------------------
    // 1. Build weekday schedule blocks
    // -------------------------------------------------------------------------
    weekdays.forEach(day => {
        const dayBlock = document.createElement('div');
        dayBlock.className = 'weekday-block';
        dayBlock.dataset.day = day;

        const header = document.createElement('div');
        header.className = 'weekday-header';
        header.innerHTML = `<strong>${day}:</strong>`;

        const addBtn = document.createElement('button');
        addBtn.className = 'add-entry';
        addBtn.innerHTML = '+';
        addBtn.title = `Add activity for ${day}`;
        addBtn.addEventListener('click', () => showEntryForm(dayBlock));

        header.appendChild(addBtn);
        dayBlock.appendChild(header);
        scheduleContainer.appendChild(dayBlock);
    });

    // -------------------------------------------------------------------------
    // 2. Schedule entry form (add / edit)
    // -------------------------------------------------------------------------
    function showEntryForm(container, existingStart = '', existingEnd = '', existingDesc = '') {
        // Remove any existing form in this block
        container.querySelectorAll('.entry-form').forEach(f => f.remove());

        const form = document.createElement('div');
        form.className = 'entry-form';

        form.innerHTML = `
            <input type="time" class="start-time" value="${existingStart}">
            <input type="time" class="end-time" value="${existingEnd}">
            <input type="text" class="activity-desc" placeholder="Activity" value="${existingDesc}">
            <button class="save-entry">Save</button>
            <button class="cancel-entry">Cancel</button>
        `;

        form.querySelector('.save-entry').addEventListener('click', () => saveEntry(container, form));
        form.querySelector('.cancel-entry').addEventListener('click', () => form.remove());

        container.appendChild(form);
    }

    function saveEntry(container, form) {
        const start = form.querySelector('.start-time').value.trim();
        const end = form.querySelector('.end-time').value.trim();
        const desc = form.querySelector('.activity-desc').value.trim();

        if (start && end && desc) {
            const entry = document.createElement('div');
            entry.className = 'schedule-entry';
            entry.innerHTML = `${start} to ${end} - ${desc} <button class="remove-entry">Remove</button>`;

            entry.querySelector('.remove-entry').addEventListener('click', (e) => {
                e.stopPropagation();
                entry.remove();
            });

            entry.addEventListener('click', () => {
                // Click on the text (not the remove button) → edit
                showEntryForm(container, start, end, desc);
                entry.remove();
            });

            // Insert right after the header
            const header = container.querySelector('.weekday-header');
            container.insertBefore(entry, header.nextSibling);
            form.remove();
        }
    }

    // -------------------------------------------------------------------------
    // 3. CPU / GPU Toggle Logic (works for all four sections)
    // -------------------------------------------------------------------------
    document.querySelectorAll('.toggle').forEach(toggle => {
        const targetId = toggle.dataset.target; // e.g. "stt-mode"
        const hiddenInput = document.getElementById(targetId);

        toggle.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                toggle.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                hiddenInput.value = btn.dataset.value;
            });
        });
    });

    // -------------------------------------------------------------------------
    // 4. Load settings from backend
    // -------------------------------------------------------------------------
    function loadSettings() {
        fetch('/api/settings')
            .then(res => res.json())
            .then(data => {
                // --- Smart plugs ---
                ['1','2','3','4'].forEach(n => {
                    document.getElementById(`user-setting-smartplug${n}-name`).value = data[`smart_plug${n}_name`] || '';
                    document.getElementById(`user-setting-smartplug${n}-ip`).value   = data[`smart_plug${n}_ip`] || '';
                });

                // --- User info ---
                document.getElementById('user-setting-name').value = data.user_name || '';
                document.getElementById('user-setting-age').value = data.user_birthday || '';
                document.getElementById('user-setting-city').value = data.location_city || '';
                document.getElementById('user-setting-latitude').value = data.location_latitude || '';
                document.getElementById('user-setting-longitude').value = data.location_longitude || '';
                document.getElementById('user-setting-additional-info').value = data.additional_info || '';

                // --- AI settings ---
                document.getElementById('setting-stt').value = data.stt || 'vosk';
                document.getElementById('setting-llm').value = data.llm || 'qwen3';
                document.getElementById('setting-llm-vl').value = data.llm_vl || 'qwen3_vl';
                document.getElementById('setting-tts').value = data.tts || 'xtts_v2';

                // Modes (cpu/gpu)
                document.getElementById('stt-mode').value = data.stt_mode || 'cpu';
                document.getElementById('llm-mode').value = data.llm_mode || 'cpu';
                document.getElementById('llm-vl-mode').value = data.llm_vl_mode || 'cpu';
                document.getElementById('tts-mode').value = data.tts_mode || 'cpu';

                // Update toggle button visuals
                document.querySelectorAll('.toggle').forEach(toggle => {
                    const mode = document.getElementById(toggle.dataset.target).value;
                    toggle.querySelectorAll('.toggle-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === mode);
                    });
                });
                updateSttToggleVisibility();

                // --- Schedule ---
                document.querySelectorAll('.schedule-entry').forEach(e => e.remove()); // clear

                weekdays.forEach(day => {
                    const key = `schedule_${day.toLowerCase()}`;
                    const lines = (data[key] || '').split('\n').filter(l => l.trim());
                    const block = document.querySelector(`.weekday-block[data-day="${day}"]`);

                    lines.forEach(line => {
                        const match = line.match(/^(.+?)\s+to\s+(.+?)\s+-\s+(.+)$/);
                        if (match) {
                            const [, start, end, desc] = match;
                            const entry = document.createElement('div');
                            entry.className = 'schedule-entry';
                            entry.innerHTML = `${start} to ${end} - ${desc} <button class="remove-entry">Remove</button>`;
                            entry.querySelector('.remove-entry').addEventListener('click', (e) => {
                                e.stopPropagation();
                                entry.remove();
                            });
                            entry.addEventListener('click', () => {
                                showEntryForm(block, start, end, desc);
                                entry.remove();
                            });
                            block.insertBefore(entry, block.querySelector('.weekday-header').nextSibling);
                        }
                    });
                });
            })
            .catch(err => console.error('Failed to load settings:', err));
    }

    // -------------------------------------------------------------------------
    // 5. Open modal → load settings
    // -------------------------------------------------------------------------
    icon.addEventListener('click', () => {
        modal.style.display = 'block';
        loadSettings();
    });

    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // -------------------------------------------------------------------------
    // 6. Tab switching
    // -------------------------------------------------------------------------
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.list;
            bodies.forEach(body => {
                body.style.display = body.dataset.list === target ? 'block' : 'none';
            });
        });
    });

    // -------------------------------------------------------------------------
    // 7. SAVE button
    // -------------------------------------------------------------------------
    document.getElementById('settings-save').addEventListener('click', () => {
        const data = {
            // Smart plugs
            smart_plug1_name: document.getElementById('user-setting-smartplug1-name').value,
            smart_plug1_ip:   document.getElementById('user-setting-smartplug1-ip').value,
            smart_plug2_name: document.getElementById('user-setting-smartplug2-name').value,
            smart_plug2_ip:   document.getElementById('user-setting-smartplug2-ip').value,
            smart_plug3_name: document.getElementById('user-setting-smartplug3-name').value,
            smart_plug3_ip:   document.getElementById('user-setting-smartplug3-ip').value,
            smart_plug4_name: document.getElementById('user-setting-smartplug4-name').value,
            smart_plug4_ip:   document.getElementById('user-setting-smartplug4-ip').value,

            // User info
            user_name:        document.getElementById('user-setting-name').value,
            user_birthday:    document.getElementById('user-setting-age').value,
            location_city:    document.getElementById('user-setting-city').value,
            location_latitude:  document.getElementById('user-setting-latitude').value,
            location_longitude: document.getElementById('user-setting-longitude').value,
            additional_info:  document.getElementById('user-setting-additional-info').value,

            // AI SETTINGS
            stt: document.getElementById('setting-stt').value,
            stt_mode:     document.getElementById('stt-mode').value,

            llm: document.getElementById('setting-llm').value,
            llm_mode:     document.getElementById('llm-mode').value,

            llm_vl: document.getElementById('setting-llm-vl').value,
            llm_vl_mode:   document.getElementById('llm-vl-mode').value,

            tts: document.getElementById('setting-tts').value,
            tts_mode:     document.getElementById('tts-mode').value,
        };

        // Schedule
        weekdays.forEach(day => {
            const entries = [];
            document.querySelectorAll(`.weekday-block[data-day="${day}"] .schedule-entry`).forEach(entry => {
                entries.push(entry.textContent.replace('Remove', '').trim());
            });
            data[`schedule_${day.toLowerCase()}`] = entries.join('\n');
        });

        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(resp => {
            console.log('Settings saved successfully:', resp);
            modal.style.display = 'none';
        })
        .catch(err => {
            console.error('Error saving settings:', err);
            alert('Failed to save settings – check console');
        });
    });
    // -------------------------------------------------------------------------
    // 8. Handle STT selection → hide/show GPU toggle for VOSK only
    // -------------------------------------------------------------------------
    const sttSelect = document.getElementById('setting-stt');
    const sttToggleWrapper = document.getElementById('stt-toggle-wrapper');
    const sttModeInput = document.getElementById('stt-mode');

    function updateSttToggleVisibility() {
        const isVosk = sttSelect.value === 'vosk';

        if (isVosk) {
            // Force CPU and hide toggle
            sttModeInput.value = 'cpu';
            sttToggleWrapper.style.display = 'none';
            // Ensure CPU button is visually active (in case reload happened)
            sttToggleWrapper.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === 'cpu');
            });
        } else {
            // Show toggle and restore saved mode (fallback to CPU)
            sttToggleWrapper.style.display = 'flex'; // or 'block' — match your CSS
        }
    }

    // Initial call (in case loaded with vosk selected)
    updateSttToggleVisibility();

    // Listen for changes
    sttSelect.addEventListener('change', updateSttToggleVisibility);
});
</script>

<style>
/* SETTINGS MODAL STYLES */
#settings-modal .modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 6px;
    width: 90%;
    max-width: 500px;
    max-height: 70vh;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
}

/* Scrollable body */
#settings-modal .settings-body {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

/* Headline styling */
#settings-modal .settings-body h3 {
    margin: 10px 0 5px;
    font-size: 16px;
}

/* Input fields: responsive and mobile-friendly */
#settings-modal .settings-body input {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

#settings-modal .settings-footer {
    text-align: center;
}

#settings-modal .settings-footer button {
    padding: 10px 20px;
    background-color: #0078D4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* Tabs */
#settings-modal .settings-tabs {
    display: flex;
    width: 100%;
    margin-bottom: 20px;
    border-bottom: 1px solid #ccc;
}

#settings-modal .settings-tab {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: color 0.3s ease;
}

#settings-modal .settings-tab.active {
    color: #000;
    font-weight: 600;
    border-bottom: 2px solid #000;
}

#settings-modal .input-row {
    display: flex;
    gap: 10px; /* spacing between inputs */
    margin-bottom: 15px;
}

#settings-modal .input-row input {
    flex: 1; /* makes both inputs equal width */
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}

/* Weekday block styling */
.weekday-block {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
    background-color: #f9f9f9;
}

.weekday-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.add-entry {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #0078D4;
}

.entry-form {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.entry-form input {
    flex: 1;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.entry-form .save-entry {
    flex: 1;
    padding: 8px; /* Match input padding */
    height: 36px; /* Match input height */
    box-sizing: border-box;
    background-color: #0078D4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 0; /* Ensure no vertical offset */
    align-self: stretch; /* Aligns with input height */
}

.schedule-entry {
    margin-bottom: 5px;
    padding: 6px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.schedule-entry button {
    margin-left: 8px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #666;
}

/* Dual control row: dropdown + toggle side by side */
.dual-control {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

/* Dropdown styling */
.dual-control select {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #fff;
    font-size: 14px;
}

/* Toggle container */
.toggle {
    display: flex;
    border: 1px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
}

/* Toggle buttons */
.toggle-btn {
    flex: 1;
    padding: 8px 12px;
    background-color: #f5f5f5;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease;
}

.toggle-btn:hover {
    background-color: #e0e0e0;
}

.toggle-btn.active {
    background-color: #0078D4;
    color: #fff;
}
</style>