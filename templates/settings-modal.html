<div id="settings-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="settings-tabs">
            <button class="settings-tab active" data-list="main">Main</button>
            <button class="settings-tab" data-list="user">User</button>
        </div>

        <div class="settings-body" data-list="main">
            <h3>Tasmota Smart Plug 1</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug1-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug1-ip" placeholder="IP">
            </div>
            <h3>Tasmota Smart Plug 2</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug2-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug2-ip" placeholder="IP">
            </div>
            <h3>Tasmota Smart Plug 3</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug3-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug3-ip" placeholder="IP">
            </div>
            <h3>Tasmota Smart Plug 4</h3>
            <div class="input-row">
                <input type="text" id="user-setting-smartplug4-name" placeholder="Name">
                <input type="text" id="user-setting-smartplug4-ip" placeholder="IP">
            </div>
            <input type="text" placeholder="Main value 4">
            <h3>Main Setting 5</h3>
            <input type="text" placeholder="Main value 5">
            <h3>Main Setting 6</h3>
            <input type="text" placeholder="Main value 6">
        </div>

        <div class="settings-body" data-list="user" style="display: none;">

            <h3>Name:</h3>
            <div class="input-row">
                <input type="text" id="user-setting-name" placeholder="Name">
                <input type="text" id="user-setting-age" placeholder="Birthday">
            </div>

            <h3>Location:</h3>
            <div class="input-row">
                <input type="text" id="user-setting-city" placeholder="City">
                <input type="text" id="user-setting-latitude" placeholder="Latitude">
                <input type="text" id="user-setting-longitude" placeholder="Longitude">
            </div>

            <h3>Schedule:</h3>
            <div id="schedule-container">
                <!-- Weekday blocks will be injected here -->
            </div>

            <h3>Additional info:</h3>
            <input type="text" id="user-setting-additional-info" placeholder="Additional info">
        </div>

        <div class="settings-footer">
            <button id="settings-save">Save</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('settings-modal');
    const icon = document.querySelector('.icon-settings');
    const tabs = modal.querySelectorAll('.settings-tab');
    const bodies = modal.querySelectorAll('.settings-body');
    const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const scheduleContainer = document.getElementById('schedule-container');

    weekdays.forEach(day => {
        const dayBlock = document.createElement('div');
        dayBlock.className = 'weekday-block';
        dayBlock.dataset.day = day;

        const header = document.createElement('div');
        header.className = 'weekday-header';
        header.innerHTML = `<strong>${day}:</strong>`;

        const addBtn = document.createElement('button');
        addBtn.className = 'add-entry';
        addBtn.innerHTML = '+';
        addBtn.title = `Add activity for ${day}`;
        addBtn.addEventListener('click', () => showEntryForm(dayBlock));

        header.appendChild(addBtn);
        dayBlock.appendChild(header);
        scheduleContainer.appendChild(dayBlock);
    });

    function showEntryForm(container) {
        const form = document.createElement('div');
        form.className = 'entry-form';

        form.innerHTML = `
            <input type="time" class="start-time" placeholder="Start">
            <input type="time" class="end-time" placeholder="End">
            <input type="text" class="activity-desc" placeholder="Activity">
            <button class="save-entry">Save</button>
        `;

        form.querySelector('.save-entry').addEventListener('click', () => {
            const start = form.querySelector('.start-time').value;
            const end = form.querySelector('.end-time').value;
            const desc = form.querySelector('.activity-desc').value;

            if (start && end && desc) {
                const entry = document.createElement('div');
                entry.className = 'schedule-entry';
                entry.innerHTML = `
                    ${start} to ${end} - ${desc}
                    <button class="remove-entry">✖</button>
                `;

                entry.querySelector('.remove-entry').addEventListener('click', () => entry.remove());
                entry.addEventListener('click', () => editEntry(entry, start, end, desc));

                container.appendChild(entry);
                form.remove();
            }
        });

        container.appendChild(form);
    }

    function editEntry(entry, start, end, desc) {
        const container = entry.parentElement;
        entry.remove();
        showEntryForm(container);

        const form = container.querySelector('.entry-form');
        form.querySelector('.start-time').value = start;
        form.querySelector('.end-time').value = end;
        form.querySelector('.activity-desc').value = desc;
    }

    // Open modal on icon click
    icon.addEventListener('click', () => {
        modal.style.display = 'block';

        fetch('/api/settings')
            .then(res => res.json())
            .then(data => {
                document.getElementById('user-setting-smartplug1-name').value = data.smart_plug1_name || '';
                document.getElementById('user-setting-smartplug1-ip').value = data.smart_plug1_ip || '';
                document.getElementById('user-setting-smartplug2-name').value = data.smart_plug2_name || '';
                document.getElementById('user-setting-smartplug2-ip').value = data.smart_plug2_ip || '';
                document.getElementById('user-setting-smartplug3-name').value = data.smart_plug3_name || '';
                document.getElementById('user-setting-smartplug3-ip').value = data.smart_plug3_ip || '';
                document.getElementById('user-setting-smartplug4-name').value = data.smart_plug4_name || '';
                document.getElementById('user-setting-smartplug4-ip').value = data.smart_plug4_ip || '';
                document.getElementById('user-setting-name').value = data.user_name || '';
                document.getElementById('user-setting-age').value = data.user_birthday || '';
                document.getElementById('user-setting-city').value = data.location_city || '';
                document.getElementById('user-setting-latitude').value = data.location_latitude || '';
                document.getElementById('user-setting-longitude').value = data.location_longitude || '';
                document.getElementById('user-setting-additional-info').value = data.additional_info || '';

                // Clear existing schedule entries
                document.querySelectorAll('.weekday-block').forEach(block => {
                    block.querySelectorAll('.schedule-entry').forEach(e => e.remove());
                });

                // Populate schedule
                ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].forEach(day => {
                    const block = document.querySelector(`.weekday-block[data-day="${day}"]`);
                    const entries = (data[`schedule_${day.toLowerCase()}`] || '').split('\n');
                    entries.forEach(line => {
                        if (line.trim()) {
                            const entry = document.createElement('div');
                            entry.className = 'schedule-entry';
                            entry.innerHTML = `${line} <button class="remove-entry">✖</button>`;
                            entry.querySelector('.remove-entry').addEventListener('click', () => entry.remove());
                            const [time, ...desc] = line.split(' - ');
                            const [start, end] = time.split(' to ');
                            entry.addEventListener('click', () => editEntry(entry, start.trim(), end.trim(), desc.join(' - ').trim()));
                            block.insertBefore(entry, block.querySelector('.weekday-header').nextSibling);
                        }
                    });
                });
            });
    });


    // Close modal when clicking outside modal-content
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Tab switching logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.list;
            bodies.forEach(body => {
                body.style.display = body.dataset.list === target ? 'block' : 'none';
            });
        });
    });
});

// save button
document.getElementById('settings-save').addEventListener('click', () => {
    const data = {
        smart_plug1_name: document.getElementById('user-setting-smartplug1-name').value,
        smart_plug1_ip: document.getElementById('user-setting-smartplug1-ip').value,
        smart_plug2_name: document.getElementById('user-setting-smartplug2-name').value,
        smart_plug2_ip: document.getElementById('user-setting-smartplug2-ip').value,
        smart_plug3_name: document.getElementById('user-setting-smartplug3-name').value,
        smart_plug3_ip: document.getElementById('user-setting-smartplug3-ip').value,
        smart_plug4_name: document.getElementById('user-setting-smartplug4-name').value,
        smart_plug4_ip: document.getElementById('user-setting-smartplug4-ip').value,
        user_name: document.getElementById('user-setting-name').value,
        user_birthday: document.getElementById('user-setting-age').value,
        location_city: document.getElementById('user-setting-city').value,
        location_latitude: document.getElementById('user-setting-latitude').value,
        location_longitude: document.getElementById('user-setting-longitude').value,
        additional_info: document.getElementById('user-setting-additional-info').value,
    };

    // Collect schedule entries
    ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].forEach(day => {
        const entries = [];
        document.querySelectorAll(`.weekday-block[data-day="${day}"] .schedule-entry`).forEach(entry => {
            entries.push(entry.textContent.replace('✖', '').trim());
        });
        data[`schedule_${day.toLowerCase()}`] = entries.join('\n');
    });

    fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        console.log('Settings saved:', response);
        document.getElementById('settings-modal').style.display = 'none';
    })
    .catch(error => {
        console.error('Error saving settings:', error);
    });
});


</script>

<style>
/* SETTINGS MODAL STYLES */
#settings-modal .modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 6px;
    width: 90%;
    max-width: 500px;
    max-height: 70vh;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
}

/* Scrollable body */
#settings-modal .settings-body {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

/* Headline styling */
#settings-modal .settings-body h3 {
    margin: 10px 0 5px;
    font-size: 16px;
}

/* Input fields: responsive and mobile-friendly */
#settings-modal .settings-body input {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

#settings-modal .settings-footer {
    text-align: center;
}

#settings-modal .settings-footer button {
    padding: 10px 20px;
    background-color: #0078D4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* Tabs */
#settings-modal .settings-tabs {
    display: flex;
    width: 100%;
    margin-bottom: 20px;
    border-bottom: 1px solid #ccc;
}

#settings-modal .settings-tab {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: color 0.3s ease;
}

#settings-modal .settings-tab.active {
    color: #000;
    font-weight: 600;
    border-bottom: 2px solid #000;
}

#settings-modal .input-row {
    display: flex;
    gap: 10px; /* spacing between inputs */
    margin-bottom: 15px;
}

#settings-modal .input-row input {
    flex: 1; /* makes both inputs equal width */
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}

/* Weekday block styling */
.weekday-block {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
    background-color: #f9f9f9;
}

.weekday-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.add-entry {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #0078D4;
}

.entry-form {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.entry-form input {
    flex: 1;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.entry-form .save-entry {
    flex: 1;
    padding: 8px; /* Match input padding */
    height: 36px; /* Match input height */
    box-sizing: border-box;
    background-color: #0078D4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 0; /* Ensure no vertical offset */
    align-self: stretch; /* Aligns with input height */
}

.schedule-entry {
    margin-bottom: 5px;
    padding: 6px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.schedule-entry button {
    margin-left: 8px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #666;
}
</style>