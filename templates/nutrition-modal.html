<!-- templates/nutrition-modal.html -->
<div id="nutrition-modal" class="nutrition-modal" style="display: none;">
  <div class="nutrition-modal-content">

    <div class="nutri-header">
      <h2 class="nutrition-title">Today</h2>
      <svg id="open-nutri-settings" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#555" viewBox="0 0 24 24" style="cursor: pointer;">
        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
      </svg>
    </div>

    <div id="nutri-settings-dialog" class="nutri-settings-dialog" style="display: none;">
      <div class="nutri-settings-content">
        <h3>Set Daily Nutrition Goals</h3>
        <label>Kcal Budget:
          <input type="number" id="input-kcal" placeholder="e.g. 2000">
        </label>
        <label>Carbs (g):
          <input type="number" id="input-carbs" placeholder="e.g. 250">
        </label>
        <label>Fat (g):
          <input type="number" id="input-fat" placeholder="e.g. 70">
        </label>
        <label>Protein (g):
          <input type="number" id="input-protein" placeholder="e.g. 100">
        </label>
        <div class="nutri-settings-buttons">
          <button id="save-nutri-settings">Save</button>
          <button id="close-nutri-settings">Close</button>
        </div>
      </div>
    </div>

    <div class="nutrition-list-container">
      <div class="nutrition-item">
          <div class="kcal-grid">
            <div class="kcal-side">
              <div class="kcal-label">Intake</div>
              <div class="kcal-value" id="kcal-intake">0 kcal</div>
            </div>

            <div class="kcal-center">
              <div class="kcal-circle" id="kcal-circle"></div>
              <div class="kcal-name">Kcal left:</div>
              <div class="kcal-left" id="kcal-left">2000 kcal</div>
            </div>

            <div class="kcal-side">
              <div class="kcal-label">Burned</div>
              <div class="kcal-value" id="kcal-burned">0 kcal</div>
            </div>
          </div>
        </div>
      <!-- carbs/fat/protein -->
      <div class="nutrition-item">
          <div class="nutri-grid">
            <div class="nutri-circle large" id="carbs-circle"></div>
            <div class="nutri-circle large" id="fat-circle"></div>
            <div class="nutri-circle large" id="protein-circle"></div>

            <div class="nutri-label">Carbs</div>
            <div class="nutri-label">Fat</div>
            <div class="nutri-label">Protein</div>

            <div class="nutri-value" id="carbs-text">0 / 250g</div>
            <div class="nutri-value" id="fat-text">0 / 70g</div>
            <div class="nutri-value" id="protein-text">0 / 100g</div>
          </div>
        </div>
    </div>
    <!-- footer -->
    <div class="nutrition-footer">
      <button id="barcode-scanner">Scan Barcode</button>
    </div>

        <div id="nutrition-scanner-overlay" class="nutrition-scanner-overlay" style="display: none;">
          <div class="nutrition-scanner-header">
            <!-- Optional top-right close button (kept for redundancy) -->
            <button id="close-scanner-top" style="background:none;border:none;color:white;font-size:28px;cursor:pointer;">X</button>
          </div>

          <video id="camera-video" autoplay playsinline style="width:100%;height:100%;object-fit:cover;"></video>

          <!-- Scan guide rectangle -->
          <div class="scan-box"></div>

          <!-- Status message -->
          <div id="nutrition-scan-result" class="nutrition-scan-result">Point camera at barcode…</div>

          <!-- Bottom button bar with Take Photo + Close -->
          <div class="scanner-bottom-bar">
            <button id="close-scanner-bottom" class="scanner-btn scanner-btn-close">Close</button>
            <button id="take-photo-btn" class="scanner-btn scanner-btn-primary">Take Photo</button>
          </div>
        </div>

    <!-- Result dialog -->
    <div id="scan-result-dialog" class="scan-result-dialog" style="display:none;">
      <div class="scan-result-content">
        <h3>Scan Result</h3>
        <p id="scan-result-text"></p>
        <div class="scan-result-buttons">
          <button id="close-result-dialog">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ─────────────────────────────────────────────────────────────────
// Modal opening + settings loading + scanner
// ─────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
  const nutritionIcon = document.getElementById('nutrition-icon');
  const nutritionModal = document.getElementById('nutrition-modal');
  const scannerOverlay = document.getElementById('nutrition-scanner-overlay');
  const takePhotoBtn = document.getElementById('take-photo-btn');
  const scanResult = document.getElementById('nutrition-scan-result');
  const video = document.getElementById('camera-video');

  // Result dialog elements
  const resultDialog = document.getElementById('scan-result-dialog');
  const resultText = document.getElementById('scan-result-text');
  const closeResultDialogBtn = document.getElementById('close-result-dialog');

  let stream = null;

  // Open the main nutrition modal
  if (nutritionIcon) {
    nutritionIcon.addEventListener('click', () => {
      nutritionModal.style.display = 'block';

      // Load current user settings
      fetch('/nutrition/settings')
        .then(res => res.json())
        .then(data => {
          const { kcal_allowed, carbs_allowed, fat_allowed, protein_allowed } = data;

          document.getElementById("kcal-left").textContent = `${kcal_allowed} kcal`;
          document.getElementById("carbs-text").textContent = `0 / ${carbs_allowed}g`;
          document.getElementById("fat-text").textContent = `0 / ${fat_allowed}g`;
          document.getElementById("protein-text").textContent = `0 / ${protein_allowed}g`;

          document.getElementById("input-kcal").value = kcal_allowed;
          document.getElementById("input-carbs").value = carbs_allowed;
          document.getElementById("input-fat").value = fat_allowed;
          document.getElementById("input-protein").value = protein_allowed;
        })
        .catch(err => console.error("Failed to load nutrition settings:", err));
    });
  }

  // Close modal when clicking background
  window.addEventListener('click', (e) => {
    if (e.target === nutritionModal) {
      nutritionModal.style.display = 'none';
      stopCamera();
    }
  });

  // ———— CAMERA & SCANNER CODE  ————
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    scannerOverlay.style.display = 'none';
  }

  function startCamera() {
    scannerOverlay.style.display = 'flex';
    scanResult.textContent = 'Loading camera…';

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        scanResult.textContent = 'Point at barcode and tap "Take Photo"';
      })
      .catch(err => {
        scanResult.textContent = 'Camera access denied';
        scanResult.style.color = 'red';
      });
  }

  document.getElementById('barcode-scanner')?.addEventListener('click', startCamera);
  document.getElementById('close-scanner-bottom')?.addEventListener('click', stopCamera);
  document.getElementById('close-scanner-top')?.addEventListener('click', stopCamera);

  takePhotoBtn.addEventListener('click', () => {
    if (!video.videoWidth || !stream?.active) return;

    takePhotoBtn.disabled = true;

    // Show result dialog immediately with waiting message
    resultText.textContent = '⏳ Waiting for response…';
    resultDialog.style.display = 'flex';

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const videoW = video.videoWidth;
    const videoH = video.videoHeight;
    const displayWidth = video.clientWidth;
    const displayHeight = video.clientHeight;

    const cropWidthPx = 250;
    const cropHeightPx = 125;

    const scaleX = videoW / displayWidth;
    const scaleY = videoH / displayHeight;

    const cropX = (displayWidth - cropWidthPx) / 2 * scaleX;
    const cropY = (displayHeight - cropHeightPx) / 2 * scaleY;
    const cropW = cropWidthPx * scaleX;
    const cropH = cropHeightPx * scaleY;

    canvas.width = cropWidthPx;
    canvas.height = cropHeightPx;

    // ✅ Draw frame first while stream is active
    ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropWidthPx, cropHeightPx);

    // Now stop the camera
    stopCamera();

    canvas.toBlob(blob => {
      const fd = new FormData();
      fd.append('file', blob, 'barcode.jpg');

      fetch('/nutrition/scan/', {
        method: 'POST',
        body: fd
      })
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(data => {
        if (!data.code) throw new Error(data.error || 'No barcode detected');
        resultText.textContent = `✅ Scanned barcode: ${data.code}`;
      })
      .catch(err => {
        console.error('Scan failed:', err);
        resultText.textContent = `❌ ${err.message || 'Scan failed'}`;
      })
      .finally(() => {
        takePhotoBtn.disabled = false;
      });
    }, 'image/jpeg', 0.9);
  });

  // Close result dialog
  closeResultDialogBtn?.addEventListener('click', () => {
    resultDialog.style.display = 'none';
    stopCamera();
  });
});
</script>

<style>
/* Result confirmation dialogue */
.scan-result-dialog {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.scan-result-content {
  background:#fff;
  padding:20px;
  border-radius:8px;
  max-width:300px;
  text-align:center;
}
.scan-result-buttons button {
  margin-top:10px;
}
</style>

<style>
/* Scanner */
.nutrition-scanner-overlay {
  display: none;
  position: fixed;
  z-index: 1001;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: black;
}

#camera-video {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scan-box {
  width: 280px;
  height: 140px;
  border: 3px dashed lime;
  border-radius: 12px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1003;
  pointer-events: none;
  box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
}

#nutrition-scan-result {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 500;
  z-index: 1002;
  max-width: 90%;
  text-align: center;
  backdrop-filter: blur(4px);
}

/* Bottom button bar — safe from Android navigation bar */
.scanner-bottom-bar {
  position: absolute;
  bottom: 80px;           /* Much higher than before */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 20px;
  z-index: 1004;
}

.scanner-btn {
  padding: 16px 32px;
  font-size: 18px;
  font-weight: 600;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  min-width: 140px;
  transition: all 0.2s;
}

.scanner-btn-close {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.scanner-btn-close:hover,
.scanner-btn-close:active {
  background: rgba(255, 255, 255, 0.3);
}

.scanner-btn-primary {
  background: #28a745;
  color: white;
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

.scanner-btn-primary:active {
  transform: translateY(2px);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.scanner-btn-primary:disabled {
  background: #666;
  cursor: not-allowed;
  box-shadow: none;
}

/* Optional top-right close button (kept for muscle memory) */
#close-scanner-top {
  position: absolute;
  top: 16px;
  right: 16px;
  z-index: 1005;
  background: rgba(0,0,0,0.5);
  width: 44px;
  height: 44px;
  border-radius: 50%;
  font-size: 28px;
  color: white;
}
</style>

<script>
  // ─────────────────────────────────────────────────────────────────
  // User daily allowed kcal
  // ─────────────────────────────────────────────────────────────────
document.addEventListener("DOMContentLoaded", () => {
  const openBtn = document.getElementById("open-nutri-settings");
  const dialog = document.getElementById("nutri-settings-dialog");
  const closeBtn = document.getElementById("close-nutri-settings");
  const saveBtn = document.getElementById("save-nutri-settings");

  const kcalInput = document.getElementById("input-kcal");
  const carbsInput = document.getElementById("input-carbs");
  const fatInput = document.getElementById("input-fat");
  const proteinInput = document.getElementById("input-protein");

  openBtn.addEventListener("click", () => {
    dialog.style.display = "flex";
  });

  closeBtn.addEventListener("click", () => {
    dialog.style.display = "none";
  });

  kcalInput.addEventListener("input", () => {
    const kcal = parseInt(kcalInput.value, 10);
    if (!isNaN(kcal) && kcal > 0) {
      // Macronutrient distribution: 50% carbs, 30% fat, 20% protein
      const carbs = Math.round((kcal * 0.50) / 4);
      const fat = Math.round((kcal * 0.30) / 9);
      const protein = Math.round((kcal * 0.20) / 4);

      carbsInput.value = carbs;
      fatInput.value = fat;
      proteinInput.value = protein;
    }
  });

  saveBtn.addEventListener("click", () => {
      const settings = {
        kcal: parseInt(kcalInput.value, 10),
        carbs: parseInt(carbsInput.value, 10),
        fat: parseInt(fatInput.value, 10),
        protein: parseInt(proteinInput.value, 10)
      };

      // Update UI labels
      document.getElementById("kcal-left").textContent = `${settings.kcal} kcal`;
      document.getElementById("carbs-text").textContent = `0 / ${settings.carbs}g`;
      document.getElementById("fat-text").textContent = `0 / ${settings.fat}g`;
      document.getElementById("protein-text").textContent = `0 / ${settings.protein}g`;

      // Send to backend
      fetch("/nutrition/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(settings)
      }).then(res => {
        if (!res.ok) console.error("Failed to save nutrition settings");
      });

      dialog.style.display = "none";
    });
});
</script>

<style>
/* Scoped styles for nutrition modal only */
.nutrition-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow: auto;
}

.nutrition-modal-content {
  background-color: white;
  margin: 15% auto;
  padding: 20px;
  border-radius: 5px;
  width: 80%;
  max-width: 500px;
  max-height: 70vh;
  position: relative;
}

.nutrition-title {
  margin-top: 0;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
}

.nutrition-list-container {
  max-height: 400px;
  overflow-y: auto;
  margin-top: 15px;
}

.nutrition-item {
  padding: 10px;
  border-bottom: 1px solid #eee;
  cursor: default;
  word-wrap: break-word;
}

.nutrition-item:hover {
  background-color: #f9f9f9;
}

.nutrition-footer {
  text-align: center;
  margin-top: 15px;
}

.nutrition-footer button {
  padding: 10px 20px;
  background-color: #0078D4;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Macronutrient circles & grid */
.nutri-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: auto auto auto;
  gap: 8px;
  text-align: center;
  align-items: center;
  justify-items: center;
  margin-top: 12px;
}

.nutri-circle.large {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: conic-gradient(#0078D4 0%, #eee 0%);
}

.nutri-label {
  font-weight: bold;
  font-size: 14px;
}

.nutri-value {
  font-size: 13px;
  color: #555;
}

/* Kcal section */
.kcal-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  text-align: center;
  gap: 12px;
  margin-top: 12px;
}

.kcal-side {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.kcal-label {
  font-size: 13px;
  color: #666;
}

.kcal-value {
  font-weight: bold;
  font-size: 14px;
}

.kcal-center {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.kcal-circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: conic-gradient(#0078D4 0%, #eee 0%);
  margin-bottom: 4px;
}

.kcal-name {
  font-weight: bold;
  font-size: 14px;
}

.kcal-left {
  font-size: 13px;
  color: #555;
  margin-top: 2px;
}

/* Header with settings gear */
.nutri-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Settings dialog */
.nutri-settings-dialog {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
}

.nutri-settings-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.nutri-settings-content h3 {
  margin-top: 0;
  text-align: center;
}

.nutri-settings-content label {
  display: flex;
  flex-direction: column;
  font-size: 14px;
}

.nutri-settings-content input {
  padding: 6px;
  font-size: 14px;
  margin-top: 4px;
}

.nutri-settings-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}

.nutri-settings-buttons button {
  padding: 8px 16px;
  border: none;
  background-color: #0078D4;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}
</style>