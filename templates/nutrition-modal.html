<!-- templates/nutrition-modal.html -->
<div id="nutrition-modal" class="nutrition-modal" style="display: none;">
  <div class="nutrition-modal-content">

    <div class="nutri-header">
      <h2 class="nutrition-title">Today</h2>
      <svg id="open-nutri-settings" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#555" viewBox="0 0 24 24" style="cursor: pointer;">
        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
      </svg>
    </div>

    <div id="nutri-settings-dialog" class="nutri-settings-dialog" style="display: none;">
      <div class="nutri-settings-content">
        <h3>Set Daily Nutrition Goals</h3>
        <label>Kcal Budget:
          <input type="number" id="input-kcal" placeholder="e.g. 2000">
        </label>
        <label>Carbs (g):
          <input type="number" id="input-carbs" placeholder="e.g. 250">
        </label>
        <label>Fat (g):
          <input type="number" id="input-fat" placeholder="e.g. 70">
        </label>
        <label>Protein (g):
          <input type="number" id="input-protein" placeholder="e.g. 100">
        </label>
        <div class="nutri-settings-buttons">
          <button id="save-nutri-settings">Save</button>
          <button id="close-nutri-settings">Close</button>
        </div>
      </div>
    </div>

    <div class="nutrition-list-container">
      <div class="nutrition-item">
          <div class="kcal-grid">
            <div class="kcal-side">
              <div class="kcal-label">Intake</div>
              <div class="kcal-value" id="kcal-intake">0 kcal</div>
            </div>

            <div class="kcal-center">
              <div class="kcal-circle" id="kcal-circle"></div>
              <div class="kcal-name">Kcal left:</div>
              <div class="kcal-left" id="kcal-left">2000 kcal</div>
            </div>

            <div class="kcal-side">
              <div class="kcal-label">Burned</div>
              <div class="kcal-value" id="kcal-burned">0 kcal</div>
            </div>
          </div>
        </div>
      <!-- carbs/fat/protein -->
      <div class="nutrition-item">
          <div class="nutri-grid">
            <div class="nutri-circle large" id="carbs-circle"></div>
            <div class="nutri-circle large" id="fat-circle"></div>
            <div class="nutri-circle large" id="protein-circle"></div>

            <div class="nutri-label">Carbs</div>
            <div class="nutri-label">Fat</div>
            <div class="nutri-label">Protein</div>

            <div class="nutri-value" id="carbs-text">0 / 250g</div>
            <div class="nutri-value" id="fat-text">0 / 70g</div>
            <div class="nutri-value" id="protein-text">0 / 100g</div>
          </div>
        </div>
    </div>
    <!-- footer -->
    <div class="nutrition-footer">
      <button id="barcode-scanner">Scan Barcode</button>
    </div>
    <div id="nutrition-scanner-overlay" class="nutrition-scanner-overlay" style="display: none;">
      <div class="nutrition-scanner-header">
        <button id="close-scanner">‚úï</button>
      </div>
      <div id="scanner-container" class="nutrition-scanner-view">
        <div class="scan-box"></div>
      </div>
      <div id="nutrition-scan-result" class="nutrition-scan-result"></div>
    </div>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Nutrition result dialog
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    const dialogHtml = `
      <div id="nutrition-result-dialog" class="nutrition-result-dialog" style="display:none;">
        <div class="nutrition-result-content">
          <div class="result-header">
            <h3 id="result-product-name">Product</h3>
            <button id="close-result-dialog" class="close-btn">√ó</button>
          </div>

          <div class="result-macros">
              <div class="per-label">per 100g/100ml</div>
              <div class="macro-header">
                <div>Kcal</div>
                <div>Carbs</div>
                <div>Fat</div>
                <div>Protein</div>
              </div>
              <div class="macro-values">
                <div id="per100-kcal">-</div>
                <div id="per100-carbs">-</div>
                <div id="per100-fat">-</div>
                <div id="per100-protein">-</div>
              </div>
            </div>

          <!-- Option 1: Item-based -->
            <div id="item-input-section" class="input-section" style="background:#f8fff8; border:1px solid #c8e6c9;">
              <div class="section-title" style="color:#2e7d32;">How many <span id="item-unit-plural">items</span> now?</div>

              <div style="display:flex; gap:10px; margin:10px 0;">
                <input type="number" min="0.1" step="0.1" id="input-items-count" placeholder="0"
                       class="nutri-input primary">
                <div style="display:flex; flex-direction:column; justify-content:center; white-space:nowrap;">
                  <span style="font-size:14px; color:#555;">‚Üí</span>
                  <strong><span id="item-grams">0</span>g</strong>
                </div>
              </div>

              <div id="package-count-wrapper">
                <label class="input-label">Total <span id="item-unit-singular">items</span> per package:</label>
                <input type="number" min="1" id="input-package-total" placeholder="0" class="nutri-input">
                <div id="package-hint" class="hint-text"></div>
              </div>
            </div>

            <!-- Option 2: Direct grams/ml -->
            <div class="input-section" style="background:#fff8e6; border:1px solid #ffdd57;">
              <div class="section-title" style="color:#e65100;">Weight or Volume</div>
              <input type="number" step="1" min="0" id="input-grams" placeholder="0" class="nutri-input primary">
              <div class="input-hint">grams or ml</div>
            </div>

          <div class="result-calculated">
              <div class="title">Will add:</div>
              <div class="calc-header">
                <div>Kcal</div>
                <div>Carbs</div>
                <div>Fat</div>
                <div>Protein</div>
              </div>
              <div class="calc-values">
                <div id="calc-kcal">0</div>
                <div id="calc-carbs">0</div>
                <div id="calc-fat">0</div>
                <div id="calc-protein">0</div>
              </div>
            </div>

          <div class="result-buttons">
            <button id="save-consumption">‚úÖ Save</button>
            <button id="cancel-consumption">Cancel</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', dialogHtml);

    const dialog = document.getElementById('nutrition-result-dialog');
    const closeBtn = document.getElementById('close-result-dialog');
    const cancelBtn = document.getElementById('cancel-consumption');
    const saveBtn = document.getElementById('save-consumption');

    let currentProduct = null;

    const closeDialog = () => {
      dialog.style.display = 'none';
      currentProduct = null;
      document.getElementById('input-items-count').value = '';
      document.getElementById('input-grams').value = '';
      document.getElementById('input-package-total').value = '';
      document.getElementById('item-grams').textContent = '0';
    };
    closeBtn.onclick = cancelBtn.onclick = closeDialog;

    const updateCalculation = () => {
      if (!currentProduct?.nutriments) return;
      const n = currentProduct.nutriments;

      const itemsInput = document.getElementById('input-items-count');
      const gramsInput = document.getElementById('input-grams');
      const packageTotalInput = document.getElementById('input-package-total');
      const itemGramsSpan = document.getElementById('item-grams');

      let finalGrams = 0;

      // Priority 1: grams input
      if (gramsInput.value) {
        finalGrams = parseFloat(gramsInput.value) || 0;
        itemsInput.value = ''; // clear items to avoid conflict
        itemGramsSpan.textContent = finalGrams.toFixed(1);
      }
      // Priority 2: item count (only if package total is known or entered)
      else if (itemsInput.value) {
        const itemsConsumed = parseFloat(itemsInput.value) || 0;
        const totalItems = parseFloat(packageTotalInput.value) || 0;

        if (totalItems > 0 && currentProduct.product_quantity > 0) {
          const gramsPerItem = currentProduct.product_quantity / totalItems;
          finalGrams = gramsPerItem * itemsConsumed;
          itemGramsSpan.textContent = finalGrams.toFixed(1);
        } else {
          itemGramsSpan.textContent = '‚ùì';
        }
      } else {
        itemGramsSpan.textContent = '0';
      }

      const factor = finalGrams / 100;
      document.getElementById('calc-kcal').textContent = Math.round((n.energy_kcal_100g || 0) * factor);
      document.getElementById('calc-carbs').textContent = ((n.carbohydrates_100g || 0) * factor).toFixed(1);
      document.getElementById('calc-fat').textContent = ((n.fat_100g || 0) * factor).toFixed(1);
      document.getElementById('calc-protein').textContent = ((n.proteins_100g || 0) * factor).toFixed(1);
    };

    // Live update on any input
    ['input-items-count', 'input-grams', 'input-package-total'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateCalculation);
    });

    window.showNutritionResultDialog = (product) => {
      currentProduct = product;

      document.getElementById('result-product-name').textContent = product.product_name || 'Unknown';

      const n = product.nutriments || {};
      document.getElementById('per100-kcal').textContent = n.energy_kcal_100g || '-';
      document.getElementById('per100-carbs').textContent = n.carbohydrates_100g || '-';
      document.getElementById('per100-fat').textContent = n.fat_100g || '-';
      document.getElementById('per100-protein').textContent = n.proteins_100g || '-';

      // ====== SMART ITEM UNIT & PACKAGE SETUP ======
      const itemNameSingular = document.getElementById('item-unit-singular');
      const itemNamePlural = document.getElementById('item-unit-plural');
      const packageHint = document.getElementById('package-hint');
      const packageTotalInput = document.getElementById('input-package-total');

      // Determine unit (singular)
      let unit = 'item';
      if (product.portion_description) {
        unit = product.portion_description.trim().toLowerCase();
      } else if (product.product_name?.toLowerCase().includes('bread')) {
        unit = 'slice';
      } else if (product.product_name?.toLowerCase().includes('egg')) {
        unit = 'egg';
      } else if (product.product_name?.toLowerCase().includes('yogurt') || product.product_name?.toLowerCase().includes('pot')) {
        unit = 'pot';
      }
      itemNameSingular.textContent = unit;
      itemNamePlural.textContent = unit + (['s', 'x', 'z'].some(c => unit.endsWith(c)) ? 'es' : unit.endsWith('y') ? 'ies' : 's');

      // Always show package wrapper (better UX)
      document.getElementById('package-count-wrapper').style.display = 'block';

      // Prefill package total if known, else hint
      let suggestedTotal = null;
      if (product.quantity && product.quantity > 0) {
        suggestedTotal = product.quantity;
      } else if (product.packaging_text) {
        const match = product.packaging_text.match(/\b(\d+)\b/);
        if (match) suggestedTotal = parseInt(match[1]);
      }

      if (suggestedTotal) {
        packageTotalInput.value = suggestedTotal;
        packageHint.textContent = `üì¶ Detected: "${product.packaging_text || product.quantity}"`;
        packageHint.style.color = '#2e7d32';
      } else {
        packageTotalInput.value = '';
        packageHint.textContent = 'üîç Tip: Enter your own count.';
        packageHint.style.color = '#777';
      }

      updateCalculation();
      dialog.style.display = 'block';
    };

    saveBtn.onclick = () => {
      if (!currentProduct) return;

      const gramsInputEl = document.getElementById('input-grams');
      const itemsInputEl = document.getElementById('input-items-count');
      const packageTotalInputEl = document.getElementById('input-package-total');

      const gramsInput = gramsInputEl.value.trim();
      const itemsInput = itemsInputEl.value.trim();
      const packageTotalInput = packageTotalInputEl.value.trim();

      let finalGrams = 0;

      if (gramsInput) {
        // Grams mode
        finalGrams = parseFloat(gramsInput);
        if (isNaN(finalGrams) || finalGrams <= 0) {
          alert("Please enter a valid amount in grams/ml (e.g. 150).");
          gramsInputEl.focus();
          return;
        }
      } else if (itemsInput) {
        // Item mode ‚Üí require package total
        const items = parseFloat(itemsInput);
        const totalItems = parseFloat(packageTotalInput);

        if (isNaN(items) || items <= 0) {
          alert("How many items are you eating? (e.g. 2 slices)");
          itemsInputEl.focus();
          return;
        }

        if (isNaN(totalItems) || totalItems <= 0) {
          alert("How many total items are in the package? (e.g. 20 slices)");
          packageTotalInputEl.focus();
          return;
        }

        if (!currentProduct.product_quantity || currentProduct.product_quantity <= 0) {
          alert("‚ö†Ô∏è Cannot convert items to grams: total product weight unknown.\nTry entering grams directly.");
          return;
        }

        const gramsPerItem = currentProduct.product_quantity / totalItems;
        finalGrams = gramsPerItem * items;
      } else {
        alert("‚ö†Ô∏è Please enter either:\n‚Ä¢ Grams/ml, OR\n‚Ä¢ Number of items + total in package");
        return;
      }

      if (finalGrams <= 0) {
        alert("Amount must be greater than zero.");
        return;
      }

      // Round to 0.1g precision
      const roundedGrams = Math.round(finalGrams * 10) / 10;

      const payload = {
        barcode: currentProduct.barcode,
        grams: roundedGrams
      };

      // Only send package_item_count if it‚Äôs new or different
      const knownQty = currentProduct.quantity;
      const userProvidedTotal = parseFloat(packageTotalInput);
      if (!isNaN(userProvidedTotal) && userProvidedTotal > 0 && (!knownQty || knownQty !== userProvidedTotal)) {
        payload.package_item_count = userProvidedTotal;
      }

      fetch('/nutrition/consume', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(res => {
        alert(res.message || "‚úÖ Logged successfully!");
        closeDialog();
        location.reload();
      })
      .catch(err => {
        console.error("Save error:", err);
        alert("‚ùå Failed to save. Please try again.");
      });
    };
  });
</script>

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Barcode scanner - quagga2 - MIT license
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
  const nutritionIcon = document.getElementById('nutrition-icon');
  const nutritionModal = document.getElementById('nutrition-modal');
  const scannerOverlay = document.getElementById('nutrition-scanner-overlay');
  const barcodeButton = document.getElementById('barcode-scanner');
  const closeScannerButton = document.getElementById('close-scanner');
  const scanResult = document.getElementById('nutrition-scan-result');

  let scanLocked = false;
  let scanBuffer = [];

  function stopScanner() {
    Quagga.stop();
    Quagga.offDetected();
    scannerOverlay.style.display = 'none';
    scanLocked = false;
  }

  nutritionIcon?.addEventListener('click', () => {
  nutritionModal.style.display = 'block';
      fetch('/nutrition/settings')
        .then(res => res.json())
        .then(data => {
          const { kcal_allowed, carbs_allowed, fat_allowed, protein_allowed } = data;

          // Update modal labels
          document.getElementById("kcal-left").textContent = `${kcal_allowed} kcal`;
          document.getElementById("carbs-text").textContent = `0 / ${carbs_allowed}g`;
          document.getElementById("fat-text").textContent = `0 / ${fat_allowed}g`;
          document.getElementById("protein-text").textContent = `0 / ${protein_allowed}g`;

          // Update settings dialog inputs
          document.getElementById("input-kcal").value = kcal_allowed;
          document.getElementById("input-carbs").value = carbs_allowed;
          document.getElementById("input-fat").value = fat_allowed;
          document.getElementById("input-protein").value = protein_allowed;
        })
        .catch(err => console.error("Failed to load nutrition settings:", err));
    });

  window.addEventListener('click', (event) => {
    if (event.target === nutritionModal) {
      nutritionModal.style.display = 'none';
      stopScanner();
    }
  });

  barcodeButton?.addEventListener('click', () => {
    scannerOverlay.style.display = 'block';
    scanResult.textContent = 'Initializing scanner‚Ä¶';
    scanResult.style.color = '';
    scanResult.style.fontWeight = '';

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(() => {
        if (typeof Quagga === 'undefined') {
          scanResult.textContent = 'Quagga2 not loaded.';
          scanResult.style.color = 'red';
          return;
        }

        const target = document.getElementById("scanner-container");
        if (!target || target.offsetParent === null) {
          scanResult.textContent = 'Scanner container not visible.';
          scanResult.style.color = 'red';
          return;
        }

        Quagga.init({
          inputStream: {
            type: "LiveStream",
            target: target,
            constraints: {
              facingMode: "environment"
            },
            area: {
            top: "40%",
            right: "10%",
            left: "10%",
            bottom: "40%"
          }
          },
          decoder: {
            readers: ["ean_reader"]
          },
          locate: true
        }, function(err) {
          if (err) {
            console.error("Quagga init error:", err);
            scanResult.textContent = `Scanner failed: ${err.message || err}`;
            scanResult.style.color = 'red';
            return;
          }

          Quagga.start();
          scanResult.textContent = "Scanning‚Ä¶";

          Quagga.onDetected((data) => {
              const code = data.codeResult.code;

              // Only accept numeric codes of expected length
              if (!code || typeof code !== 'string' || code.length < 6) return;

              scanBuffer.push(code);

              scanResult.textContent = `Scanned ${scanBuffer.length}/10‚Ä¶`;
              scanResult.style.color = 'orange';
              scanResult.style.fontWeight = 'bold';

              if (scanBuffer.length >= 10) {
                Quagga.offDetected(); // stop further detection

                fetch('/barcode', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ barcodes: scanBuffer })
                })
                .then(response => response.json())
                .then(product => {
                  // Hide scanner immediately
                  stopScanner();
                  scanBuffer = [];

                  // New dialog
                  if (typeof showNutritionResultDialog === 'function') {
                    showNutritionResultDialog(product);
                  } else {
                    console.error("showNutritionResultDialog not available");
                  }
                })
                .catch(err => {
                  scanResult.textContent = `‚ùå Server error: ${err.message}`;
                  scanResult.style.color = 'red';
                  scanBuffer = [];
                });
              }
            });
        });
      })
      .catch((err) => {
        scanResult.textContent = `Camera access denied: ${err.message || err}`;
        scanResult.style.color = 'red';
      });
  });

  closeScannerButton?.addEventListener('click', stopScanner);
});
</script>

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // User daily allowed kcal
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener("DOMContentLoaded", () => {
  const openBtn = document.getElementById("open-nutri-settings");
  const dialog = document.getElementById("nutri-settings-dialog");
  const closeBtn = document.getElementById("close-nutri-settings");
  const saveBtn = document.getElementById("save-nutri-settings");

  const kcalInput = document.getElementById("input-kcal");
  const carbsInput = document.getElementById("input-carbs");
  const fatInput = document.getElementById("input-fat");
  const proteinInput = document.getElementById("input-protein");

  openBtn.addEventListener("click", () => {
    dialog.style.display = "flex";
  });

  closeBtn.addEventListener("click", () => {
    dialog.style.display = "none";
  });

  kcalInput.addEventListener("input", () => {
    const kcal = parseInt(kcalInput.value, 10);
    if (!isNaN(kcal) && kcal > 0) {
      // Macronutrient distribution: 50% carbs, 30% fat, 20% protein
      const carbs = Math.round((kcal * 0.50) / 4);
      const fat = Math.round((kcal * 0.30) / 9);
      const protein = Math.round((kcal * 0.20) / 4);

      carbsInput.value = carbs;
      fatInput.value = fat;
      proteinInput.value = protein;
    }
  });

  saveBtn.addEventListener("click", () => {
      const settings = {
        kcal: parseInt(kcalInput.value, 10),
        carbs: parseInt(carbsInput.value, 10),
        fat: parseInt(fatInput.value, 10),
        protein: parseInt(proteinInput.value, 10)
      };

      // Update UI labels
      document.getElementById("kcal-left").textContent = `${settings.kcal} kcal`;
      document.getElementById("carbs-text").textContent = `0 / ${settings.carbs}g`;
      document.getElementById("fat-text").textContent = `0 / ${settings.fat}g`;
      document.getElementById("protein-text").textContent = `0 / ${settings.protein}g`;

      // Send to backend
      fetch("/nutrition/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(settings)
      }).then(res => {
        if (!res.ok) console.error("Failed to save nutrition settings");
      });

      dialog.style.display = "none";
    });
});
</script>

<style>
/* Scoped styles for nutrition modal only */
.nutrition-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow: auto;
}

.nutrition-modal-content {
  background-color: white;
  margin: 15% auto;
  padding: 20px;
  border-radius: 5px;
  width: 80%;
  max-width: 500px;
  max-height: 70vh;
  position: relative;
}

.nutrition-title {
  margin-top: 0;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
}

.nutrition-list-container {
  max-height: 400px;
  overflow-y: auto;
  margin-top: 15px;
}

.nutrition-item {
  padding: 10px;
  border-bottom: 1px solid #eee;
  cursor: default;
  word-wrap: break-word;
}

.nutrition-item:hover {
  background-color: #f9f9f9;
}

.nutrition-footer {
  text-align: center;
  margin-top: 15px;
}

.nutrition-footer button {
  padding: 10px 20px;
  background-color: #0078D4;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.nutrition-scanner-overlay {
  display: none;
  position: fixed;
  z-index: 1001;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.85);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.nutrition-scanner-header {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1002;
}

.nutrition-scanner-view {
  width: 100vw;
  height: 100vh;
  position: relative;
}

.nutrition-scan-result {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 18px;
  background-color: rgba(0,0,0,0.6);
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 1002;
}

.scan-box {
  width: 250px;
  height: 125px;
  border: 2px dashed lime;
  position: absolute;
  top: 25%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1003;
  pointer-events: none;
}

.nutri-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: auto auto auto;
  gap: 8px;
  text-align: center;
  align-items: center;
  justify-items: center;
  margin-top: 12px;
}

.nutri-circle.large {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: conic-gradient(#0078D4 0%, #eee 0%);
}

.nutri-label {
  font-weight: bold;
  font-size: 14px;
}

.nutri-value {
  font-size: 13px;
  color: #555;
}

.kcal-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  text-align: center;
  gap: 12px;
  margin-top: 12px;
}

.kcal-side {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.kcal-label {
  font-size: 13px;
  color: #666;
}

.kcal-value {
  font-weight: bold;
  font-size: 14px;
}

.kcal-center {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.kcal-circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: conic-gradient(#0078D4 0%, #eee 0%);
  margin-bottom: 4px;
}

.kcal-name {
  font-weight: bold;
  font-size: 14px;
}

.kcal-left {
  font-size: 13px;
  color: #555;
  margin-top: 2px;
}


.nutri-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.nutri-settings-dialog {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
}

.nutri-settings-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.nutri-settings-content h3 {
  margin-top: 0;
  text-align: center;
}

.nutri-settings-content label {
  display: flex;
  flex-direction: column;
  font-size: 14px;
}

.nutri-settings-content input {
  padding: 6px;
  font-size: 14px;
  margin-top: 4px;
}

.nutri-settings-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}

.nutri-settings-buttons button {
  padding: 8px 16px;
  border: none;
  background-color: #0078D4;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}


.nutrition-result-dialog {
  position: fixed; inset: 0; background: rgba(0,0,0,0.75);
  display: flex; align-items: center; justify-content: center;
  z-index: 10000;
}
.nutrition-result-content {
  background: white;
  border-radius: 14px;
  padding: 20px;
  width: 90%;
  max-width: 380px;               /* 4. narrower dialog */
  font-family: system-ui, sans-serif;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* 1. Center headline & buttons */
.result-header {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  margin-bottom: 16px;
}
.result-header h3 { margin: 0; font-size: 1.4rem; }
.close-btn {
  position: absolute;
  right: 0;
  background:none; border:none; font-size:28px; cursor:pointer;
}

/* 2. Compact & centered per-100g block */
.result-macros {
  margin: 12px 0;
  text-align: center;
}
.result-macros .per-label {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
}
.result-macros .macro-header {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
  font-size: 12px;
  font-weight: 600;
  color: #555;
  margin-bottom: 4px;
}
.result-macros .macro-values {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
  font-size: 16px;
  font-weight: 700;
}
.result-macros .macro-values div {
  /* Optional: subtle visual grouping */
  padding: 6px 2px;
}

/* 4. Smaller inputs */
.result-inputs input {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
}
.result-inputs label {
  margin: 14px 0 6px;
  display: block;
  font-weight: 500;
}
.or-separator {
  text-align:center;
  margin:12px 0;
  color:#777;
  font-weight:500;
}

/* 5. ‚ÄúWill add‚Äù layout */
.result-calculated {
  margin: 16px 0;
  padding: 14px;
  background: #f9f9f9;
  border-radius: 10px;
  text-align: center;
}
.result-calculated .title {
  font-weight: 600;
  font-size: 14px;
  color: #444;
  margin-bottom: 8px;
}
.result-calculated .calc-header {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}
.result-calculated .calc-values {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
  font-size: 16px;
  font-weight: 700;
}
.result-calculated .calc-values div {
  padding: 6px 2px;
}

/* Buttons centered */
.result-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
}
.result-buttons button {
  padding: 11px 24px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.result-buttons button:first-child {
  background: #28a745;
  color: white;
}
.result-buttons button:last-child {
  background: #ddd;
}


/* Unified input styling */
.nutri-input {
  width: 100%;
  padding: 10px 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 2px solid #ccc;
  box-sizing: border-box;
  text-align: center;
  font-family: inherit;
}

.nutri-input:focus {
  outline: none;
  border-color: #4caf50;
}

.nutri-input.primary {
  font-size: 18px;
  padding: 12px;
}

.input-section {
  margin: 14px 0;
  padding: 14px;
  border-radius: 10px;
}

.section-title {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 10px;
}

.input-label {
  font-size: 13px;
  color: #1b5e20;
  display: block;
  margin: 8px 0 4px;
}

.input-hint {
  font-size: 13px;
  color: #666;
  text-align: center;
  margin-top: 6px;
}

.hint-text {
  font-size: 12px;
  color: #555;
  margin-top: 4px;
}
</style>
